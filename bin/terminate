if [ $# -lt 1 ] && [ -z ${WADAL_PROF} ]; then
    echo 'enter profile or specify WADAL_PROF envvar'
    exit 0
fi

if [ -z ${WADAL_PROF} ]; then
    PROF=$1
else
    PROF=${WADAL_PROF}
fi

source profiles/$PROF

if [ ! -z $GIT_REPO ]; then
    DIR="$(basename $GIT_REPO)"
    GIT_PATH="/home/hadoop/works/$DIR"
    TEST_COMMIT="cd $GIT_PATH; git status --porcelain | grep '^ M.*' | wc -l"
    TEST_PUSH="cd $GIT_PATH; git cherry -v | wc -l"
fi

CLUSTER=`cat "clusters/${PROF}_cluster.id"`

function terminate() {
    echo "Cluster $CLUSTER terminated."
    aws emr terminate-clusters --cluster-ids $CLUSTER --region=$AWS_REGION
    rm clusters/${PROF}_cluster.id
}

uncmt=$(ssh -o StrictHostKeyChecking=no -i $EC2_KEY_PAIR_PATH hadoop@$(aws emr describe-cluster --cluster-id $CLUSTER --region=$AWS_REGION | grep MasterPublicDns | cut -d':' -f2 | tr -d ' ",') "$TEST_COMMIT")
unpush=$(ssh -o StrictHostKeyChecking=no -i $EC2_KEY_PAIR_PATH hadoop@$(aws emr describe-cluster --cluster-id $CLUSTER --region=$AWS_REGION | grep MasterPublicDns | cut -d':' -f2 | tr -d ' ",') "$TEST_PUSH")
if [ $uncmt -gt 0 ] || [ $unpush -gt 0 ]; then
    echo "There are $uncmt uncommitted file(s) and $unpush unpushed commit(s)!!"
    read -p "Are you sure? " -n 1 -r
    echo    # (optional) move to a new line
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        terminate
    else
        echo "Canceled."
    fi
else
    terminate
fi

